<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANI-ME é›²ç«¯å…±äº«ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --bg: #0c0c0c; --card: #1c1c1c; --text: #ffffff; --accent: #00b4d8; --sub: #888; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; padding-bottom: 50px; }
        #login-overlay { position: fixed; inset: 0; background: #000; z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .login-box { background: #1a1a1a; padding: 30px; border-radius: 15px; width: 85%; max-width: 350px; text-align: center; border: 1px solid #333; }
        nav { background: #000; padding: 12px 20px; display: flex; gap: 15px; position: sticky; top: 0; z-index: 100; align-items: center; border-bottom: 1px solid #222; }
        nav .logo { color: var(--accent); font-weight: 900; font-size: 1.5rem; cursor: pointer; margin-right: auto; }
        nav a { color: #eee; text-decoration: none; font-size: 0.95rem; font-weight: bold; cursor: pointer; }
        nav a.active { color: var(--accent); border-bottom: 2px solid var(--accent); }
        .container { padding: 15px; max-width: 1400px; margin: auto; }
        .section-title { border-left: 6px solid var(--accent); padding-left: 12px; margin: 20px 0; font-size: 1.5rem; font-weight: bold; }
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        @media (min-width: 768px) { .grid { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); } }
        .card { background: var(--card); border-radius: 8px; overflow: hidden; border: 1px solid #222; position: relative; cursor: pointer; }
        .card img { width: 100%; aspect-ratio: 3/4; object-fit: cover; }
        .ep-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(65px, 1fr)); gap: 10px; margin-top: 15px; }
        .ep-item { background: #252525; color: #ccc; padding: 12px 5px; text-align: center; border-radius: 4px; cursor: pointer; border: 1px solid #333; }
        .ep-item.current { background: var(--accent); color: white; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: #222; padding: 25px; border-radius: 12px; width: 100%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; border-radius: 5px; border: 1px solid #444; background: #111; color: white; box-sizing: border-box; }
        .btn { border: none; padding: 10px 18px; border-radius: 20px; font-weight: bold; cursor: pointer; }
        .btn-accent { background: var(--accent); color: white; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <h2 style="color: var(--accent);">ANI-ME å…±äº«</h2>
        <input type="text" id="input-group-key" placeholder="è¼¸å…¥ 8 ä½å…±äº«ä»£ç¢¼">
        <button class="btn btn-accent" style="width: 100%; margin-top: 10px;" onclick="joinGroup()">é€²å…¥æˆ¿é–“</button>
        <div style="margin: 20px 0; color: #555;">â”€â”€â”€â”€â”€ æˆ–è€… â”€â”€â”€â”€â”€</div>
        <button class="btn" style="width: 100%; background: #333; color: white;" onclick="createNewGroup()">å‰µå»ºæ–°çš„éš¨æ©Ÿç¾¤çµ„</button>
    </div>
</div>

<nav>
    <div class="logo" onclick="showPage('home')">ANI-ME</div>
    <a onclick="showPage('home')" id="nav-home" class="active">é¦–é </a>
    <a onclick="showPage('all')" id="nav-all">æ‰€æœ‰å‹•ç•«</a>
    <a onclick="showPage('my')" id="nav-my">æˆ‘çš„æ”¶è—</a>
    <div style="margin-left: 20px; display: flex; gap: 10px;">
        <button class="btn btn-accent" onclick="copyGroupKey()">ğŸ“‹ è¤‡è£½æ­¤æˆ¿é–“ä»£ç¢¼</button>
        <button class="btn" style="background:#333; color:white;" onclick="logout()">ç™»å‡º</button>
    </div>
</nav>

<div class="container" id="main-page">
    <div id="display-content"></div>
</div>

<div class="container" id="detail-page" style="display:none;">
    <button onclick="showPage(lastPage)" style="color:var(--accent); background:none; border:none; cursor:pointer; font-weight:bold;">â† è¿”å›</button>
    <div id="detail-content"></div>
</div>

<div class="modal" id="animeModal">
    <div class="modal-content">
        <h3>ç·¨è¼¯å‹•ç•«</h3>
        <input type="hidden" id="edit-id">
        <input type="text" id="m-title" placeholder="ä½œå“åç¨±">
        <input type="text" id="m-img" placeholder="å°é¢ç¶²å€">
        <input type="text" id="m-year" placeholder="å¹´ä»½">
        <textarea id="m-links" rows="5" placeholder="æ’­æ”¾é€£çµ (ä¸€é›†ä¸€è¡Œ)"></textarea>
        <button onclick="saveAnime()" class="btn btn-accent" style="width:100%;">å„²å­˜ä¸¦åŒæ­¥</button>
        <button onclick="closeModal()" style="width:100%; background:none; color:#888; border:none; margin-top:10px; cursor:pointer;">å–æ¶ˆ</button>
    </div>
</div>

<button onclick="openModal()" style="position:fixed; bottom:20px; right:20px; width:60px; height:60px; border-radius:50%; background:var(--accent); color:white; border:none; font-size:30px; cursor:pointer; box-shadow:0 4px 10px rgba(0,0,0,0.5); z-index:99;">+</button>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB_LCa3ZOmcALbxw5SFjx78DzDD3mopXV4",
        authDomain: "aniworld-e53fb.firebaseapp.com",
        projectId: "aniworld-e53fb",
        databaseURL: "https://aniworld-e53fb-default-rtdb.firebaseio.com/",
        storageBucket: "aniworld-e53fb.firebasestorage.app",
        messagingSenderId: "436374917789",
        appId: "1:436374917789:web:11f19fe22e81763231fa74"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let animes = [], groupKey = "", currentPage = 'home', lastPage = 'home';

    // ç”Ÿæˆéš¨æ©Ÿ 8 ä½ä»£ç¢¼
    function generateID() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // æ’é™¤æ˜“æ··æ·†å­—æ¯
        let result = '';
        for (let i = 0; i < 8; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
        return result;
    }

    function createNewGroup() {
        const newKey = generateID();
        if(confirm("å°‡å»ºç«‹æ–°æˆ¿é–“ï¼Œä»£ç¢¼ç‚ºï¼š" + newKey + "\nè«‹å‹™å¿…è¨˜ä¸‹æ­¤ä»£ç¢¼ä»¥åˆ†äº«çµ¦æœ‹å‹ã€‚")) {
            localStorage.setItem('ani_room_id', newKey);
            location.reload();
        }
    }

    function joinGroup() {
        const key = document.getElementById('input-group-key').value.trim().toUpperCase();
        if (key.length < 4) return alert("è«‹è¼¸å…¥æ­£ç¢ºçš„ä»£ç¢¼");
        localStorage.setItem('ani_room_id', key);
        location.reload();
    }

    function copyGroupKey() {
        navigator.clipboard.writeText(groupKey);
        alert("æˆ¿é–“ä»£ç¢¼ " + groupKey + " å·²è¤‡è£½ï¼å‚³çµ¦æœ‹å‹è¼¸å…¥å³å¯åŒæ­¥ã€‚");
    }

    function logout() { localStorage.removeItem('ani_room_id'); location.reload(); }

    function startSync() {
        groupKey = localStorage.getItem('ani_room_id');
        if (!groupKey) return;
        document.getElementById('login-overlay').style.display = 'none';
        db.ref('rooms/' + groupKey).on('value', (snapshot) => {
            const data = snapshot.val();
            animes = data ? Object.values(data) : [];
            renderContent();
        });
    }

    function saveAnime() {
        const id = document.getElementById('edit-id').value || Date.now();
        const data = {
            id: parseInt(id),
            title: document.getElementById('m-title').value || "æœªå‘½å",
            img: document.getElementById('m-img').value || "",
            year: document.getElementById('m-year').value || "2024",
            links: document.getElementById('m-links').value.split('\n').filter(l => l.trim() !== ""),
            currentEp: id ? (animes.find(a=>a.id==id)?.currentEp || 0) : 0,
            isFav: id ? (animes.find(a=>a.id==id)?.isFav || false) : false,
            lastActionTime: Date.now()
        };
        db.ref('rooms/' + groupKey + '/' + data.id).update(data).then(() => closeModal());
    }

    function renderContent() {
        const area = document.getElementById('display-content');
        let list = [...animes];
        let title = "æœ€è¿‘è§€çœ‹";
        if (currentPage === 'all') title = "æ‰€æœ‰å‹•ç•«";
        else if (currentPage === 'my') { list = list.filter(a => a.isFav); title = "æ”¶è—æ¸…å–®"; }
        else { list = list.sort((a,b) => b.lastActionTime - a.lastActionTime); }

        area.innerHTML = `<h2 class="section-title">${title}</h2><div class="grid"></div>`;
        const grid = area.querySelector('.grid');
        if(list.length === 0) grid.innerHTML = "<p style='color:#444'>æˆ¿é–“ç©ºç©ºçš„ï¼Œé»å³ä¸‹è§’ + æ–°å¢å§ï¼</p>";
        list.forEach(a => {
            grid.innerHTML += `
                <div class="card" onclick="openDetail(${a.id})">
                    <button style="position:absolute;top:5px;right:5px;background:rgba(0,0,0,0.5);border:none;color:${a.isFav?'#ff4d4d':'#ccc'};border-radius:50%;width:30px;height:30px;cursor:pointer;" onclick="event.stopPropagation(); db.ref('rooms/'+groupKey+'/'+${a.id}).update({isFav:${!a.isFav}})">â¤</button>
                    <img src="${a.img || 'https://via.placeholder.com/180x260'}">
                    <div class="card-info">
                        <div style="font-weight:bold;font-size:0.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${a.title}</div>
                        <div style="font-size:0.75rem;color:var(--sub);margin-top:4px;">çœ‹åˆ°ç¬¬ ${a.currentEp || 0} é›†</div>
                    </div>
                </div>`;
        });
    }

    function openDetail(id) {
        const a = animes.find(i => i.id === id);
        if (!a) return showPage('home');
        currentPage = 'detail';
        document.getElementById('main-page').style.display = 'none';
        document.getElementById('detail-page').style.display = 'block';
        document.getElementById('detail-content').innerHTML = `
            <div style="display:flex; gap:15px; background:#151515; padding:15px; border-radius:10px;">
                <img src="${a.img}" style="width:120px; border-radius:5px;">
                <div>
                    <h2 style="margin:0">${a.title}</h2>
                    <p style="color:var(--accent)">${a.year}</p>
                    <button class="btn" onclick="openModal(${a.id})" style="background:#333;color:white;padding:5px 15px">ç·¨è¼¯</button>
                    <button class="btn" onclick="if(confirm('åˆªé™¤ï¼Ÿ')){db.ref('rooms/'+groupKey+'/'+${a.id}).remove(); showPage('home');}" style="background:#400;color:white;padding:5px 15px;margin-left:5px">åˆªé™¤</button>
                </div>
            </div>
            <div class="ep-list">${a.links.map((l, i) => `<div class="ep-item ${i+1===a.currentEp?'current':''}" onclick="playEp(${a.id},${i+1},'${l}')">${i+1}</div>`).join('')}</div>
        `;
    }

    function playEp(id, ep, url) {
        db.ref('rooms/' + groupKey + '/' + id).update({ currentEp: ep, lastActionTime: Date.now() });
        window.open(url, '_blank');
    }

    function showPage(page) {
        lastPage = currentPage; currentPage = page;
        document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
        if(document.getElementById('nav-'+page)) document.getElementById('nav-'+page).classList.add('active');
        document.getElementById('main-page').style.display = (page==='detail'?'none':'block');
        document.getElementById('detail-page').style.display = (page==='detail'?'block':'none');
        renderContent();
    }

    function openModal(id = null) {
        document.getElementById('animeModal').style.display = 'flex';
        if(id) {
            const a = animes.find(i => i.id === id);
            document.getElementById('edit-id').value = a.id;
            document.getElementById('m-title').value = a.title;
            document.getElementById('m-img').value = a.img;
            document.getElementById('m-year').value = a.year;
            document.getElementById('m-links').value = a.links.join('\n');
        } else {
            document.getElementById('edit-id').value = "";
            document.getElementById('m-title').value = "";
            document.getElementById('m-img').value = "";
            document.getElementById('m-year').value = "";
            document.getElementById('m-links').value = "";
        }
    }

    function closeModal() { document.getElementById('animeModal').style.display = 'none'; }
    window.onload = startSync;
</script>
</body>
</html>

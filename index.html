<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ANIWORLD | SYSTEM V24.2</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              accent: '#00f2ff',
              'accent-pink': '#ff00c1',
              'bg-dark': '#05060f',
              'bg-canvas': '#0a0b18',
              'panel-bg': 'rgba(15, 16, 32, 0.98)',
              'card-surface': 'rgba(255, 255, 255, 0.06)',
            },
            fontFamily: {
              sans: ['Outfit', 'Noto Sans TC', 'sans-serif'],
            },
            screens: {
              'xs': '480px', // Custom breakpoint for large phones
            }
          }
        }
      }
    </script>

    <!-- 2. Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;900&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- 3. React & Babel (For running JSX in browser without build step) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Firebase Compat -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  </head>
  <body class="bg-bg-dark text-white font-sans antialiased overflow-x-hidden selection:bg-accent selection:text-black">
    <div id="root"></div>

    <!-- MAIN APPLICATION SCRIPT -->
    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      // --- Firebase Service ---
      const firebaseConfig = {
          apiKey: "AIzaSyB_LCa3ZOmcALbxw5SFjx78DzDD3mopXV4",
          databaseURL: "https://aniworld-e53fb-default-rtdb.asia-southeast1.firebasedatabase.app/"
      };

      let db = null;
      const getDb = () => {
          if (!firebase.apps.length) {
              firebase.initializeApp(firebaseConfig);
          }
          if (!db) db = firebase.database();
          return db;
      };

      // --- Constants ---
      const WEEK_DAYS = ["週一", "週二", "週三", "週四", "週五", "週六", "週日", "完結"];
      const TAG_POOL = ["熱血", "冒險", "校園", "戀愛", "異世界", "奇幻", "日常", "懸疑", "百合", "耽美", "戰鬥", "美食", "機甲", "治癒", "後宮", "肉番", "運動", "智鬥", "科幻", "搞笑", "溫馨", "暗黑", "魔法", "偶像", "驚悚"];

      // --- Helper Components ---
      const Badge = ({ children, active }) => (
        <span className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider ${active ? 'bg-accent text-black' : 'bg-white/10 text-white'}`}>
          {children}
        </span>
      );

      const Tag = ({ label, active, onClick }) => (
        <button
          onClick={onClick}
          className={`px-3 py-1.5 rounded-full text-xs font-bold transition-all whitespace-nowrap border ${
            active 
              ? 'bg-accent-pink border-accent-pink text-white shadow-[0_0_10px_rgba(255,0,193,0.4)]' 
              : 'bg-card-surface border-white/10 text-gray-400 hover:border-accent hover:text-accent'
          }`}
        >
          {label}
        </button>
      );

      // --- Main App Component ---
      function App() {
        // State
        const [loading, setLoading] = useState(true);
        const [dataList, setDataList] = useState([]);
        const [chatMessages, setChatMessages] = useState([]);
        
        // Navigation & Filtering
        const [currentTab, setCurrentTab] = useState('home');
        const [searchTerm, setSearchTerm] = useState('');
        const [activeFilterTag, setActiveFilterTag] = useState('全部');
        const [room, setRoom] = useState('');
        const [user, setUser] = useState('');
        
        // UI State
        const [isChatOpen, setIsChatOpen] = useState(false);
        const [chatInput, setChatInput] = useState('');
        const [isEditModalOpen, setIsEditModalOpen] = useState(false);
        const [isDetailModalOpen, setIsDetailModalOpen] = useState(false);
        const [selectedItem, setSelectedItem] = useState(null);

        // Editor State
        const [editForm, setEditForm] = useState({});
        const [editDay, setEditDay] = useState('週一');
        const [editLinksRaw, setEditLinksRaw] = useState('');

        // Refs
        const chatBottomRef = useRef(null);
        const bannerRef = useRef(null);

        // --- Initialization ---
        useEffect(() => {
          let storedRoom = localStorage.getItem('ani_v24_room');
          let storedUser = localStorage.getItem('ani_v24_user');

          if (!storedRoom) {
            storedRoom = prompt("聖域房號 (Room ID):")?.toUpperCase() || 'PUBLIC';
            localStorage.setItem('ani_v24_room', storedRoom);
          }
          if (!storedUser) {
            storedUser = prompt("冒險者稱號 (Username):") || '冒險者';
            localStorage.setItem('ani_v24_user', storedUser);
          }
          setRoom(storedRoom);
          setUser(storedUser);

          const database = getDb();
          const dataRef = database.ref(`rooms/${storedRoom}/data`);
          const chatRef = database.ref(`rooms/${storedRoom}/chat`).limitToLast(50);

          dataRef.on('value', (snap) => {
            const val = snap.val();
            const list = val ? Object.values(val) : [];
            setDataList(list);
            setLoading(false);
          });

          chatRef.on('value', (snap) => {
            const val = snap.val();
            const msgs = val ? Object.entries(val).map(([k, v]) => ({ ...v, id: k })) : [];
            setChatMessages(msgs);
          });

          return () => {
            dataRef.off();
            chatRef.off();
          };
        }, []);

        useEffect(() => {
          if (isChatOpen && chatBottomRef.current) {
            chatBottomRef.current.scrollIntoView({ behavior: 'smooth' });
          }
        }, [chatMessages, isChatOpen]);

        // --- Computed Data ---
        const filteredData = dataList.filter(item => {
          if (currentTab === 'anime' && item.type === 'manga') return false;
          if (currentTab === 'manga' && item.type !== 'manga') return false;
          if (currentTab === 'fav' && !item.fav) return false;
          if (currentTab === 'hist' && !item.lastEp) return false;
          if (searchTerm && !item.title.toLowerCase().includes(searchTerm.toLowerCase())) return false;
          if (activeFilterTag !== '全部' && !item.tags?.includes(activeFilterTag)) return false;
          return true;
        }).sort((a, b) => b.timestamp - a.timestamp);

        // --- Handlers ---
        const handleChatSend = () => {
          if (!chatInput.trim()) return;
          getDb().ref(`rooms/${room}/chat`).push({
            u: user,
            t: chatInput,
            ts: Date.now()
          });
          setChatInput('');
        };

        const toggleFav = (e, item) => {
          e.stopPropagation();
          const newState = !item.fav;
          getDb().ref(`rooms/${room}/data/${item.id}`).update({ fav: newState });
        };

        const handleOpenDetail = (item) => {
          setSelectedItem(item);
          setIsDetailModalOpen(true);
        };

        const handleOpenEdit = (item) => {
          if (item) {
            setSelectedItem(item);
            setEditForm(item);
            setEditDay(item.day || '週一');
            setEditLinksRaw(item.links?.join('\n') || '');
          } else {
            setSelectedItem(null);
            setEditForm({ 
              id: Date.now().toString(), 
              type: 'anime', 
              tags: [],
              year: '2025',
              month: '1月'
            });
            setEditDay('週一');
            setEditLinksRaw('');
          }
          setIsDetailModalOpen(false);
          setIsEditModalOpen(true);
        };

        const handleSaveData = () => {
          if (!editForm.title) return alert("請輸入標題");
          
          const id = editForm.id || Date.now().toString();
          const payload = {
            ...editForm,
            id,
            day: editDay,
            links: editLinksRaw.split('\n').filter(l => l.trim()),
            timestamp: Date.now()
          };

          getDb().ref(`rooms/${room}/data/${id}`).update(payload);
          setIsEditModalOpen(false);
        };

        const handleDelete = () => {
          if (!editForm.id || !confirm("確定刪除?")) return;
          getDb().ref(`rooms/${room}/data/${editForm.id}`).remove();
          setIsEditModalOpen(false);
        };

        const handleFetchMeta = async () => {
          const url = prompt("請輸入網站 URL:");
          if (!url) return;
          
          const btn = document.getElementById('fetch-btn');
          if(btn) btn.innerText = "Loading...";

          try {
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
            const res = await fetch(proxyUrl);
            const html = await res.text();
            const doc = new DOMParser().parseFromString(html, "text/html");

            const ogTitle = doc.querySelector('meta[property="og:title"]')?.getAttribute('content') || doc.title;
            const ogImg = doc.querySelector('meta[property="og:image"]')?.getAttribute('content');
            
            if (ogTitle) setEditForm(prev => ({ ...prev, title: ogTitle.split(' - ')[0] }));
            if (ogImg) {
               let finalImg = ogImg;
               if(ogImg.startsWith('/')) {
                   finalImg = new URL(url).origin + ogImg;
               }
               setEditForm(prev => ({ ...prev, img: finalImg }));
            }
            if (!editLinksRaw) setEditLinksRaw(`第01集|${url}`);

          } catch (e) {
            alert("抓取失敗");
          } finally {
            if(btn) btn.innerText = "智能抓取";
          }
        };

        const openLink = (item, linkStr, index) => {
            const url = linkStr.includes('|') ? linkStr.split('|')[1] : linkStr;
            getDb().ref(`rooms/${room}/data/${item.id}`).update({ lastEp: index + 1, timestamp: Date.now() });
            window.open(url, '_blank');
        };

        // --- Render ---

        if (loading) {
          return (
            <div className="flex flex-col items-center justify-center h-screen bg-bg-dark">
              <div className="w-16 h-16 border-4 border-accent/20 border-t-accent rounded-full animate-spin mb-4"></div>
              <div className="text-accent tracking-widest animate-pulse">SYSTEM INITIALIZING...</div>
            </div>
          );
        }

        return (
          <div className="min-h-screen pb-24 md:pb-0">
            
            {/* Header */}
            <header className="fixed top-0 left-0 w-full z-40 bg-panel-bg/80 backdrop-blur-md border-b border-white/10 h-16 flex items-center justify-between px-4 transition-all">
              <div className="flex items-center gap-3">
                  <h1 className="text-2xl font-black tracking-tighter bg-clip-text text-transparent bg-gradient-to-br from-accent to-accent-pink cursor-pointer" onClick={() => window.location.reload()}>
                      ANIWORLD
                  </h1>
                  <span className="hidden sm:block text-[10px] bg-accent/10 border border-accent text-accent px-2 py-0.5 rounded-full font-bold">
                      #{room}
                  </span>
              </div>
              <div className="flex items-center gap-4">
                  <i className="fa-solid fa-magnifying-glass text-gray-400 sm:hidden" onClick={() => document.getElementById('search-bar')?.focus()}></i>
                  <div className="hidden sm:block relative">
                      <input 
                          type="text" 
                          placeholder="Search..." 
                          className="bg-black/40 border border-white/20 rounded-full py-1.5 px-4 text-sm w-48 focus:border-accent focus:outline-none focus:w-64 transition-all"
                          value={searchTerm}
                          onChange={(e) => setSearchTerm(e.target.value)}
                      />
                  </div>
                  <div className="relative cursor-pointer" onClick={() => setIsChatOpen(true)}>
                      <i className="fa-solid fa-bell text-gray-400 hover:text-accent transition-colors"></i>
                  </div>
                  <div className="w-8 h-8 rounded-full border border-accent overflow-hidden">
                      <img src={`https://api.dicebear.com/7.x/adventurer/svg?seed=${user}`} alt="User" />
                  </div>
              </div>
            </header>

            {/* Hero Section */}
            <section className="relative w-full h-[30vh] sm:h-[45vh] mt-16 overflow-hidden group">
              <img 
                  ref={bannerRef}
                  src="https://images.alphacoders.com/133/1339031.png" 
                  className="absolute inset-0 w-full h-full object-cover opacity-60 group-hover:scale-105 transition-transform duration-700" 
                  alt="Banner" 
              />
              <div className="absolute inset-0 bg-gradient-to-t from-bg-dark via-bg-dark/50 to-transparent"></div>
              <div className="absolute bottom-6 left-4 sm:left-10 right-4">
                  <h2 className="text-4xl sm:text-6xl font-black uppercase leading-none tracking-tighter mb-2">
                      System <span className="text-transparent bg-clip-text bg-gradient-to-r from-accent to-accent-pink">V24.2</span>
                  </h2>
                  <div className="sm:hidden mt-4 relative">
                      <input 
                          id="search-bar"
                          type="text" 
                          placeholder="搜尋..." 
                          className="w-full bg-white/10 backdrop-blur-md border border-white/20 rounded-xl py-2 px-4 text-base text-white focus:border-accent outline-none"
                          value={searchTerm}
                          onChange={(e) => setSearchTerm(e.target.value)}
                      />
                      <i className="fa-solid fa-search absolute right-4 top-3 text-gray-400"></i>
                  </div>
              </div>
            </section>

            {/* Filter Tags */}
            <div className="px-4 py-4 overflow-x-auto no-scrollbar flex gap-2 sticky top-16 bg-bg-dark/95 z-30 backdrop-blur-sm border-b border-white/5">
               <Tag label="全部" active={activeFilterTag === '全部'} onClick={() => setActiveFilterTag('全部')} />
               {TAG_POOL.map(t => (
                   <Tag key={t} label={t} active={activeFilterTag === t} onClick={() => setActiveFilterTag(t)} />
               ))}
            </div>

            {/* Main Grid */}
            <main className="p-3 sm:p-6 pb-24">
              {/* 
                  Mobile Portrait: grid-cols-3 (High Density)
                  Large Phone/Landscape: grid-cols-4
                  Tablet: grid-cols-5
                  Desktop: grid-cols-6
              */}
              <div className="grid grid-cols-3 xs:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-3 sm:gap-6">
                  {filteredData.map(item => (
                      <div 
                          key={item.id} 
                          className="group relative bg-card-surface rounded-xl overflow-hidden border border-white/5 hover:border-accent hover:-translate-y-1 transition-all duration-300 cursor-pointer shadow-lg"
                          onClick={() => handleOpenDetail(item)}
                      >
                          <div className="aspect-[3/4.2] overflow-hidden relative">
                              <img src={item.img || 'https://via.placeholder.com/300x420?text=No+Img'} className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" loading="lazy" />
                              <div className="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                              <button 
                                  className={`absolute top-2 right-2 w-7 h-7 sm:w-8 sm:h-8 rounded-full flex items-center justify-center backdrop-blur-md transition-all ${item.fav ? 'bg-accent-pink text-white scale-110' : 'bg-black/40 text-white/50 hover:bg-white hover:text-black'}`}
                                  onClick={(e) => toggleFav(e, item)}
                              >
                                  <i className="fa-solid fa-heart text-[10px] sm:text-xs"></i>
                              </button>
                              {item.lastEp && (
                                  <div className="absolute bottom-2 right-2 bg-accent text-black text-[10px] font-black px-1.5 py-0.5 rounded">
                                      EP{item.lastEp}
                                  </div>
                              )}
                          </div>
                          <div className="p-2 sm:p-3">
                              <div className="flex items-center gap-1 mb-1">
                                  <Badge>{item.type === 'manga' ? '漫' : '動'}</Badge>
                                  {item.day && <span className="text-[9px] sm:text-[10px] text-gray-400">{item.day}</span>}
                              </div>
                              <h3 className="font-bold text-xs sm:text-sm text-white leading-tight line-clamp-1 group-hover:text-accent">
                                  {item.title}
                              </h3>
                          </div>
                      </div>
                  ))}
              </div>
              
              {filteredData.length === 0 && (
                  <div className="text-center py-20 text-gray-500">
                      <i className="fa-solid fa-ghost text-4xl mb-4 opacity-50"></i>
                      <p>No Data Found</p>
                  </div>
              )}
            </main>

            {/* Mobile Nav */}
            <nav className="fixed bottom-0 left-0 w-full bg-panel-bg/95 backdrop-blur-xl border-t border-white/10 flex justify-around items-center h-16 sm:hidden z-50 pb-safe">
              <button onClick={() => setCurrentTab('home')} className={`flex flex-col items-center gap-1 w-full h-full justify-center ${currentTab === 'home' ? 'text-accent' : 'text-gray-500'}`}>
                  <i className="fa-solid fa-house text-lg"></i>
                  <span className="text-[10px]">首頁</span>
              </button>
              <button onClick={() => setCurrentTab('anime')} className={`flex flex-col items-center gap-1 w-full h-full justify-center ${currentTab === 'anime' ? 'text-accent' : 'text-gray-500'}`}>
                  <i className="fa-solid fa-film text-lg"></i>
                  <span className="text-[10px]">動畫</span>
              </button>
              <div className="relative -top-5">
                  <button 
                      onClick={() => handleOpenEdit()}
                      className="w-14 h-14 rounded-full bg-gradient-to-tr from-accent to-accent-pink shadow-[0_0_20px_rgba(0,242,255,0.4)] flex items-center justify-center text-white text-xl border-4 border-bg-dark"
                  >
                      <i className="fa-solid fa-plus"></i>
                  </button>
              </div>
              <button onClick={() => setCurrentTab('manga')} className={`flex flex-col items-center gap-1 w-full h-full justify-center ${currentTab === 'manga' ? 'text-accent' : 'text-gray-500'}`}>
                  <i className="fa-solid fa-book-open text-lg"></i>
                  <span className="text-[10px]">漫畫</span>
              </button>
              <button onClick={() => setCurrentTab('fav')} className={`flex flex-col items-center gap-1 w-full h-full justify-center ${currentTab === 'fav' ? 'text-accent' : 'text-gray-500'}`}>
                  <i className="fa-solid fa-heart text-lg"></i>
                  <span className="text-[10px]">收藏</span>
              </button>
            </nav>

            {/* Desktop FAB */}
            <button 
              onClick={() => handleOpenEdit()} 
              className="hidden sm:flex fixed bottom-10 right-10 w-14 h-14 bg-accent hover:bg-white text-black rounded-full items-center justify-center shadow-lg shadow-accent/40 transition-all hover:scale-110 z-40"
            >
              <i className="fa-solid fa-plus text-xl"></i>
            </button>

            {/* Detail Modal */}
            {isDetailModalOpen && selectedItem && (
                <div className="fixed inset-0 z-[60] flex items-end sm:items-center justify-center sm:p-4 bg-black/80 backdrop-blur-sm" onClick={() => setIsDetailModalOpen(false)}>
                    <div 
                      className="w-full sm:max-w-4xl bg-[#10111f] sm:rounded-3xl rounded-t-3xl border border-white/10 overflow-hidden flex flex-col sm:flex-row max-h-[90vh] sm:h-auto animate-slide-up"
                      onClick={e => e.stopPropagation()}
                    >
                        <div className="relative w-full sm:w-1/3 h-64 sm:h-auto bg-black">
                            <img src={selectedItem.img} className="w-full h-full object-cover opacity-60" />
                            <div className="absolute inset-0 bg-gradient-to-t from-[#10111f] to-transparent sm:bg-gradient-to-r"></div>
                            <img src={selectedItem.img} className="absolute bottom-4 left-4 w-32 rounded-lg shadow-2xl border border-white/20 sm:hidden" />
                        </div>
                        
                        <div className="flex-1 p-6 overflow-y-auto">
                            <div className="flex justify-between items-start mb-4">
                                <div>
                                  <div className="flex gap-2 mb-2">
                                      <Badge active>{selectedItem.type}</Badge>
                                      <span className="text-xs text-gray-400">{selectedItem.year} {selectedItem.month}</span>
                                  </div>
                                  <h2 className="text-2xl sm:text-4xl font-black leading-none mb-4">{selectedItem.title}</h2>
                                </div>
                                <button onClick={() => handleOpenEdit(selectedItem)} className="w-10 h-10 rounded-full bg-white/5 hover:bg-accent hover:text-black flex items-center justify-center transition-colors">
                                   <i className="fa-solid fa-gear"></i>
                                </button>
                            </div>

                            <div className="flex flex-wrap gap-2 mb-8">
                                {selectedItem.tags?.map(t => <span key={t} className="text-xs text-gray-400 border border-white/10 px-2 py-1 rounded">{t}</span>)}
                            </div>

                            <div className="border-t border-white/10 pt-6">
                                <h3 className="text-accent font-bold mb-4 flex items-center gap-2">
                                    <i className="fa-solid fa-layer-group"></i> 選集列表
                                </h3>
                                <div className="grid grid-cols-5 sm:grid-cols-6 gap-2 sm:gap-3">
                                    {selectedItem.links?.map((link, idx) => (
                                        <button 
                                          key={idx}
                                          onClick={() => openLink(selectedItem, link, idx)}
                                          className={`py-2 sm:py-3 rounded-lg font-bold text-xs sm:text-sm transition-all border ${
                                              (selectedItem.lastEp || 0) === idx + 1 
                                              ? 'bg-accent text-black border-accent' 
                                              : 'bg-white/5 border-white/5 hover:border-accent hover:text-accent'
                                          }`}
                                        >
                                            {idx + 1}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Editor Modal */}
            {isEditModalOpen && (
                <div className="fixed inset-0 z-[70] flex items-center justify-center p-0 sm:p-4 bg-black/90 backdrop-blur-md">
                   <div className="w-full h-full sm:h-auto sm:max-w-2xl bg-bg-dark sm:rounded-2xl border border-white/10 flex flex-col">
                       <div className="p-4 border-b border-white/10 flex justify-between items-center bg-white/5">
                           <h3 className="font-bold text-lg"><i className="fa-solid fa-pen-to-square text-accent mr-2"></i> 數據維護</h3>
                           <button onClick={() => setIsEditModalOpen(false)} className="w-8 h-8 rounded-full hover:bg-white/10"><i className="fa-solid fa-xmark"></i></button>
                       </div>
                       
                       <div className="flex-1 overflow-y-auto p-6 space-y-6">
                           <div className="flex gap-2">
                               <input 
                                  className="flex-1 bg-black border border-white/20 rounded-lg px-4 py-2 text-sm focus:border-accent outline-none" 
                                  placeholder="智能抓取網址..."
                                  id="fetch-input" 
                               />
                               <button id="fetch-btn" onClick={handleFetchMeta} className="bg-gradient-to-r from-purple-600 to-pink-600 px-4 rounded-lg text-sm font-bold whitespace-nowrap">
                                  <i className="fa-solid fa-bolt mr-1"></i> 抓取
                               </button>
                           </div>

                           <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                               <div>
                                   <label className="text-xs text-gray-500 font-bold block mb-1">標題</label>
                                   <input value={editForm.title || ''} onChange={e => setEditForm({...editForm, title: e.target.value})} className="w-full bg-card-surface border border-white/10 rounded px-3 py-2 outline-none focus:border-accent" />
                               </div>
                               <div>
                                   <label className="text-xs text-gray-500 font-bold block mb-1">封面 URL</label>
                                   <input value={editForm.img || ''} onChange={e => setEditForm({...editForm, img: e.target.value})} className="w-full bg-card-surface border border-white/10 rounded px-3 py-2 outline-none focus:border-accent" />
                               </div>
                           </div>

                           <div className="grid grid-cols-3 gap-3">
                              <select value={editForm.type} onChange={e => setEditForm({...editForm, type: e.target.value})} className="bg-card-surface border border-white/10 rounded px-2 py-2 text-sm outline-none">
                                  <option value="anime">Anime</option>
                                  <option value="manga">Manga</option>
                              </select>
                              <select value={editForm.year} onChange={e => setEditForm({...editForm, year: e.target.value})} className="bg-card-surface border border-white/10 rounded px-2 py-2 text-sm outline-none">
                                  {Array.from({length: 25}, (_, i) => 2026 - i).map(y => <option key={y} value={y}>{y}</option>)}
                              </select>
                              <select value={editForm.month} onChange={e => setEditForm({...editForm, month: e.target.value})} className="bg-card-surface border border-white/10 rounded px-2 py-2 text-sm outline-none">
                                  {Array.from({length: 12}, (_, i) => i + 1).map(m => <option key={m} value={`${m}月`}>{m}月</option>)}
                              </select>
                           </div>

                           <div>
                              <label className="text-xs text-gray-500 font-bold block mb-2">更新週期</label>
                              <div className="flex flex-wrap gap-2">
                                  {WEEK_DAYS.map(d => (
                                      <button key={d} onClick={() => setEditDay(d)} className={`px-3 py-1 text-xs rounded border ${editDay === d ? 'bg-accent text-black border-accent' : 'border-white/10'}`}>{d}</button>
                                  ))}
                              </div>
                           </div>

                           <div>
                              <label className="text-xs text-gray-500 font-bold block mb-2">標籤</label>
                              <div className="flex flex-wrap gap-2 max-h-32 overflow-y-auto p-2 border border-white/10 rounded">
                                  {TAG_POOL.map(t => (
                                      <button 
                                          key={t} 
                                          onClick={() => {
                                              const tags = editForm.tags || [];
                                              const newTags = tags.includes(t) ? tags.filter(x => x !== t) : [...tags, t];
                                              setEditForm({...editForm, tags: newTags});
                                          }}
                                          className={`text-[10px] px-2 py-1 rounded transition-colors ${editForm.tags?.includes(t) ? 'bg-accent-pink text-white' : 'bg-white/5 text-gray-400'}`}
                                      >
                                          {t}
                                      </button>
                                  ))}
                              </div>
                           </div>

                           <textarea 
                              value={editLinksRaw}
                              onChange={e => setEditLinksRaw(e.target.value)}
                              placeholder="格式: 第01集|URL (每行一個)"
                              className="w-full h-32 bg-black/40 border border-white/10 rounded p-3 text-xs font-mono outline-none focus:border-accent"
                           ></textarea>
                       </div>

                       <div className="p-4 border-t border-white/10 flex gap-3 bg-white/5">
                           {editForm.id && (
                               <button onClick={handleDelete} className="px-4 py-3 rounded-lg bg-red-500/20 text-red-500 hover:bg-red-500 hover:text-white transition-colors">
                                  <i className="fa-solid fa-trash"></i>
                               </button>
                           )}
                           <button onClick={handleSaveData} className="flex-1 bg-accent hover:bg-white text-black font-bold py-3 rounded-lg transition-colors">
                              儲存變更
                           </button>
                       </div>
                   </div>
                </div>
            )}

            {/* Chat Sidebar */}
            <div className={`fixed inset-y-0 right-0 w-full sm:w-80 bg-panel-bg/95 backdrop-blur-xl border-l border-white/10 z-[80] transform transition-transform duration-300 flex flex-col ${isChatOpen ? 'translate-x-0' : 'translate-x-full'}`}>
                <div className="p-4 border-b border-white/10 flex justify-between items-center">
                    <h3 className="font-bold">聖域頻道</h3>
                    <button onClick={() => setIsChatOpen(false)}><i className="fa-solid fa-xmark"></i></button>
                </div>
                <div className="flex-1 overflow-y-auto p-4 space-y-4">
                    {chatMessages.map(msg => (
                        <div key={msg.id} className={`flex flex-col ${msg.u === user ? 'items-end' : 'items-start'}`}>
                            <span className="text-[10px] text-gray-500 mb-1">{msg.u}</span>
                            <div className={`max-w-[85%] px-4 py-2 rounded-2xl text-sm ${msg.u === user ? 'bg-accent text-black rounded-br-none' : 'bg-white/10 rounded-bl-none'}`}>
                                {msg.t}
                            </div>
                        </div>
                    ))}
                    <div ref={chatBottomRef} />
                </div>
                <div className="p-4 border-t border-white/10 flex gap-2">
                    <input 
                      value={chatInput}
                      onChange={e => setChatInput(e.target.value)}
                      onKeyPress={e => e.key === 'Enter' && handleChatSend()}
                      className="flex-1 bg-black/40 border border-white/10 rounded-full px-4 py-2 text-sm outline-none focus:border-accent"
                      placeholder="發送訊息..."
                    />
                    <button onClick={handleChatSend} className="w-10 h-10 rounded-full bg-accent text-black flex items-center justify-center">
                        <i className="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
            </div>

          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‹äººå‹•ç•«ç˜‹ - åŒæ­¥å„ªåŒ–ç‰ˆ</title>
    <style>
        :root { --bg: #0c0c0c; --card: #1c1c1c; --text: #ffffff; --accent: #00b4d8; --sub: #888; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; padding-bottom: 50px; }
        
        /* å°è¦½åˆ— */
        nav { background: #000; padding: 12px 20px; display: flex; gap: 15px; position: sticky; top: 0; z-index: 100; align-items: center; flex-wrap: wrap; border-bottom: 1px solid #222; }
        nav .logo { color: var(--accent); font-weight: 900; font-size: 1.5rem; cursor: pointer; margin-right: 10px; }
        nav a { color: #eee; text-decoration: none; font-size: 1rem; font-weight: bold; cursor: pointer; transition: 0.2s; }
        nav a.active { color: var(--accent); border-bottom: 2px solid var(--accent); padding-bottom: 5px; }
        
        .container { padding: 15px; max-width: 1400px; margin: auto; }
        .section-title { border-left: 6px solid var(--accent); padding-left: 12px; margin: 20px 0; font-size: 1.5rem; font-weight: bold; }
        
        /* ç¶²æ ¼å¸ƒå±€ */
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        @media (min-width: 768px) { .grid { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); } }
        
        /* å‹•ç•«å¡ç‰‡ */
        .card { background: var(--card); border-radius: 8px; overflow: hidden; border: 1px solid #222; position: relative; cursor: pointer; transition: transform 0.2s; }
        .card:hover { transform: translateY(-5px); border-color: var(--accent); }
        .card img { width: 100%; aspect-ratio: 3/4; object-fit: cover; }
        .card-info { padding: 10px; }
        .card-title { font-size: 0.95rem; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .fav-btn { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.6); border: none; color: #888; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 1.2rem; z-index: 5; }
        .fav-btn.active { color: #ff4d4d; }

        /* å‹•ç•«ç˜‹é¢¨æ ¼é›†æ•¸åˆ—è¡¨ */
        .ep-list { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
        @media (min-width: 480px) { .ep-list { grid-template-columns: repeat(6, 1fr); } }
        @media (min-width: 768px) { .ep-list { grid-template-columns: repeat(auto-fill, minmax(65px, 1fr)); } }
        .ep-item { background: #252525; color: #ccc; padding: 12px 5px; text-align: center; border-radius: 4px; cursor: pointer; border: 1px solid #333; font-weight: bold; transition: 0.2s; }
        .ep-item:hover { background: #333; color: white; border-color: var(--accent); }
        .ep-item.current { background: var(--accent); color: white; border-color: white; }

        /* å½ˆçª—èˆ‡æŒ‰éˆ• */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: #222; padding: 25px; border-radius: 12px; width: 100%; max-width: 550px; max-height: 85vh; overflow-y: auto; }
        input, textarea { width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px; border: 1px solid #444; background: #111; color: white; box-sizing: border-box; }
        
        .nav-btns { margin-left: auto; display: flex; gap: 8px; flex-wrap: wrap; }
        .btn { border: none; padding: 7px 14px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 0.85rem; }
        .btn-share { background: #333; color: white; }
        .btn-import { background: #444; color: white; }
        .btn-add { background: var(--accent); color: white; }
        
        #detail-page { display: none; }
        .tag-pool { display: flex; flex-wrap: wrap; gap: 8px; background: #111; padding: 15px; border-radius: 8px; border: 1px solid #333; }
        .tag-choice { padding: 5px 12px; background: #333; border-radius: 20px; font-size: 0.8rem; cursor: pointer; }
        .tag-choice.selected { background: var(--accent); color: white; }
    </style>
</head>
<body>

<nav>
    <div class="logo" onclick="showPage('home')">ANI-ME</div>
    <a onclick="showPage('home')" id="nav-home" class="active">é¦–é </a>
    <a onclick="showPage('all')" id="nav-all">æ‰€æœ‰å‹•ç•«</a>
    <a onclick="showPage('my')" id="nav-my">æˆ‘çš„å‹•ç•«</a>
    <a onclick="showPage('history')" id="nav-history">è§€çœ‹ç´€éŒ„</a>
    
    <div class="nav-btns">
        <button class="btn btn-share" onclick="generateShareCode()">ğŸ“¤ ç”Ÿæˆåˆ†äº«ç¢¼</button>
        <button class="btn btn-import" onclick="importShareCode()">ğŸ“¥ è¼¸å…¥ä»£ç¢¼</button>
        <button class="btn btn-add" onclick="openModal()">+ æ–°å¢</button>
    </div>
</nav>

<div class="container" id="main-page">
    <div id="filter-area" style="display:none; margin-bottom: 20px;">
        <div id="tag-filters" style="display:flex; gap:10px; overflow-x:auto; white-space:nowrap; padding-bottom:10px;"></div>
    </div>
    <div id="display-content"></div>
</div>

<div class="container" id="detail-page">
    <button onclick="showPage(lastPage)" style="background:none; color:var(--accent); border:none; cursor:pointer; font-weight:bold; margin-bottom:15px;">â† è¿”å›ä¸Šä¸€é </button>
    <div id="detail-content"></div>
</div>

<div class="modal" id="animeModal">
    <div class="modal-content">
        <h3 id="modalTitle">ç·¨è¼¯å‹•ç•«ä½œå“</h3>
        <input type="hidden" id="edit-id">
        <input type="text" id="m-title" placeholder="ä½œå“åç¨±">
        <input type="text" id="m-img" placeholder="å°é¢åœ–ç‰‡ URL (ä¾‹å¦‚: https://...)">
        <input type="text" id="m-year" placeholder="å¹´ä»½ (å¦‚ 2024)">
        <label style="color:var(--sub); font-size:0.8rem;">æ¨™ç±¤åˆ†é¡</label>
        <div class="tag-pool" id="modal-tag-pool"></div>
        <textarea id="m-links" rows="5" placeholder="æ’­æ”¾é€£çµ (è«‹ä¸€é›†è²¼ä¸Šä¸€å€‹ç¶²å€ï¼Œæ›è¡Œå³ç‚ºä¸‹ä¸€é›†)"></textarea>
        <button onclick="saveAnime()" style="width:100%; padding:15px; background:var(--accent); color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer; margin-top:10px;">å„²å­˜ä¸¦æ›´æ–°</button>
        <button onclick="closeModal()" style="width:100%; margin-top:10px; background:none; color:var(--sub); border:none; cursor:pointer;">å–æ¶ˆ</button>
    </div>
</div>

<script>
    const PRESET_TAGS = ["ç†±è¡€", "å†’éšª", "æˆ€æ„›", "æ ¡åœ’", "ç•°ä¸–ç•Œ", "å¥‡å¹»", "æ¨ç†", "æç¬‘", "æ²»ç™’", "æ‡¸ç–‘", "ç§‘å¹»", "ç¾é£Ÿ"];
    let animes = JSON.parse(localStorage.getItem('ani_share_v2_data')) || [];
    let currentPage = 'home', lastPage = 'home', currentFilterTag = 'å…¨éƒ¨', selectedTags = [];

    // --- åŠŸèƒ½ 1: ç”Ÿæˆéš¨æ©Ÿåˆ†äº«ä»£ç¢¼ ---
    function generateShareCode() {
        if (animes.length === 0) return alert("ç›®å‰æ¸…å–®æ˜¯ç©ºçš„ï¼Œç„¡æ³•ç”Ÿæˆåˆ†äº«ç¢¼ã€‚");
        const code = btoa(encodeURIComponent(JSON.stringify(animes)));
        const dummy = document.createElement("textarea");
        document.body.appendChild(dummy);
        dummy.value = code;
        dummy.select();
        document.execCommand("copy");
        document.body.removeChild(dummy);
        alert("åˆ†äº«ç¢¼å·²éš¨æ©Ÿç”Ÿæˆä¸¦è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼\nä½ å¯ä»¥å‚³çµ¦æœ‹å‹å›‰ã€‚");
    }

    // --- åŠŸèƒ½ 2: è¼¸å…¥æœ‹å‹ä»£ç¢¼ ---
    function importShareCode() {
        const inputCode = prompt("è«‹è²¼ä¸Šæœ‹å‹åˆ†äº«çµ¦ä½ çš„ä»£ç¢¼ï¼š");
        if (inputCode) {
            try {
                const decoded = JSON.parse(decodeURIComponent(atob(inputCode)));
                if (confirm("ç¢ºå®šåŒ¯å…¥ï¼Ÿé€™æœƒè¦†è“‹é€™å°è¨­å‚™ç›®å‰çš„å‹•ç•«æ¸…å–®ã€‚")) {
                    animes = decoded;
                    localStorage.setItem('ani_share_v2_data', JSON.stringify(animes));
                    renderContent();
                    alert("åŒæ­¥æˆåŠŸï¼");
                }
            } catch(e) { alert("ç„¡æ•ˆçš„ä»£ç¢¼ï¼Œè«‹ç¢ºèªæ˜¯å¦å®Œæ•´è¤‡è£½ã€‚"); }
        }
    }

    function showPage(page) {
        lastPage = currentPage; currentPage = page;
        document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
        if(document.getElementById('nav-'+page)) document.getElementById('nav-'+page).classList.add('active');
        document.getElementById('main-page').style.display = (page==='detail'?'none':'block');
        document.getElementById('detail-page').style.display = (page==='detail'?'block':'none');
        document.getElementById('filter-area').style.display = (page==='all'?'block':'none');
        renderContent();
    }

    function saveAnime() {
        const id = document.getElementById('edit-id').value;
        const data = {
            id: id ? parseInt(id) : Date.now(),
            title: document.getElementById('m-title').value || "æœªå‘½å",
            img: document.getElementById('m-img').value || "",
            year: document.getElementById('m-year').value || "2024",
            tags: selectedTags,
            links: document.getElementById('m-links').value.split('\n').filter(l => l.trim() !== ""),
            currentEp: id ? animes.find(a => a.id == id).currentEp : 0,
            isFav: id ? animes.find(a => a.id == id).isFav : false,
            lastActionTime: Date.now()
        };
        if(id) animes[animes.findIndex(a => a.id == id)] = data; else animes.push(data);
        localStorage.setItem('ani_share_v2_data', JSON.stringify(animes));
        closeModal(); 
        renderContent(); // å„²å­˜å®Œç«‹å³æ¸²æŸ“
    }

    function renderContent() {
        const area = document.getElementById('display-content');
        let list = [...animes];
        let title = "æœ€è¿‘æ›´æ–°";

        if(currentPage === 'all') {
            title = "æ‰€æœ‰å‹•ç•«";
            if(currentFilterTag !== 'å…¨éƒ¨') list = list.filter(a => a.tags.includes(currentFilterTag));
            const activeTags = ['å…¨éƒ¨', ...new Set(animes.flatMap(a => a.tags))];
            document.getElementById('tag-filters').innerHTML = activeTags.map(t => `<div class="tag-choice ${currentFilterTag===t?'selected':''}" onclick="currentFilterTag='${t}';renderContent()">${t}</div>`).join('');
        } else if(currentPage === 'my') {
            list = list.filter(a => a.isFav); title = "æˆ‘çš„æ”¶è—";
        } else if(currentPage === 'history') {
            list = list.sort((a,b) => b.lastActionTime - a.lastActionTime); title = "è§€çœ‹ç´€éŒ„";
        } else {
            list = list.slice(-10).reverse();
        }

        area.innerHTML = `<h2 class="section-title">${title}</h2><div class="grid"></div>`;
        const grid = area.querySelector('.grid');
        if(list.length === 0) grid.innerHTML = `<p style="color:#666; padding:10px;">ç›®å‰æ²’æœ‰è³‡æ–™ï¼Œé»æ“Šã€Œè¼¸å…¥ä»£ç¢¼ã€æˆ–ã€Œæ–°å¢ã€ä¾†é–‹å§‹å§ï¼</p>`;
        
        list.forEach(a => {
            grid.innerHTML += `
                <div class="card" onclick="openDetail(${a.id})">
                    <button class="fav-btn ${a.isFav?'active':''}" onclick="event.stopPropagation(); toggleFav(${a.id})">â¤</button>
                    <img src="${a.img || 'https://via.placeholder.com/180x260?text=No+Image'}">
                    <div class="card-info">
                        <div class="card-title">${a.title}</div>
                        <div style="font-size:0.8rem; color:var(--sub); margin-top:5px;">ä¸Šæ¬¡çœ‹åˆ°ï¼šç¬¬ ${a.currentEp} é›†</div>
                    </div>
                </div>`;
        });
    }

    function openDetail(id) {
        const a = animes.find(i => i.id === id);
        document.getElementById('detail-content').innerHTML = `
            <div style="display:flex; gap:20px; flex-wrap:wrap; background:#151515; padding:25px; border-radius:15px; border: 1px solid #333;">
                <img src="${a.img || 'https://via.placeholder.com/180x260?text=No+Image'}" style="width:180px; border-radius:10px; box-shadow: 0 4px 15px rgba(0,0,0,0.5);">
                <div style="flex:1; min-width:280px;">
                    <h1 style="margin:0 0 10px 0; font-size:2rem;">${a.title}</h1>
                    <p style="color:var(--accent); font-weight:bold; font-size:1.1rem; margin-bottom:15px;">${a.year} å¹´ | ${a.tags.join('ã€')}</p>
                    <div style="display:flex; gap:10px;">
                        <button onclick="openModal(${a.id})" style="background:#444; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; font-weight:bold;">ç·¨è¼¯è³‡è¨Š</button>
                        <button onclick="deleteAnime(${a.id})" style="background:#600; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; font-weight:bold;">åˆªé™¤ä½œå“</button>
                    </div>
                </div>
            </div>
            <h2 class="section-title">é¸æ“‡é›†æ•¸</h2>
            <div class="ep-list">${a.links.map((l, i) => `<div class="ep-item ${i+1===a.currentEp?'current':''}" onclick="playEp(${a.id},${i+1},'${l}')">${(i+1).toString().padStart(2,'0')}</div>`).join('')}</div>
        `;
        showPage('detail');
    }

    function playEp(id, ep, url) {
        const idx = animes.findIndex(a => a.id === id);
        animes[idx].currentEp = ep;
        animes[idx].lastActionTime = Date.now();
        localStorage.setItem('ani_share_v2_data', JSON.stringify(animes));
        window.open(url, '_blank');
        openDetail(id); // æ›´æ–°ç•¶å‰é›†æ•¸çš„é«˜äº®ç‹€æ…‹
    }

    function toggleFav(id) {
        const idx = animes.findIndex(x => x.id === id);
        animes[idx].isFav = !animes[idx].isFav;
        localStorage.setItem('ani_share_v2_data', JSON.stringify(animes));
        renderContent();
    }

    function deleteAnime(id) {
        if(confirm('ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™éƒ¨å‹•ç•«å—ï¼Ÿ')) {
            animes = animes.filter(x => x.id !== id);
            localStorage.setItem('ani_share_v2_data', JSON.stringify(animes));
            showPage('home');
        }
    }

    function openModal(id = null) {
        document.getElementById('animeModal').style.display = 'flex';
        const pool = document.getElementById('modal-tag-pool');
        if(id) {
            const a = animes.find(i => i.id === id);
            document.getElementById('edit-id').value = a.id;
            document.getElementById('m-title').value = a.title;
            document.getElementById('m-img').value = a.img;
            document.getElementById('m-year').value = a.year;
            document.getElementById('m-links').value = a.links.join('\n');
            selectedTags = [...a.tags];
        } else {
            document.getElementById('edit-id').value = "";
            document.getElementById('m-title').value = "";
            document.getElementById('m-img').value = "";
            document.getElementById('m-year').value = "";
            document.getElementById('m-links').value = "";
            selectedTags = [];
        }
        pool.innerHTML = PRESET_TAGS.map(t => `<div class="tag-choice ${selectedTags.includes(t)?'selected':''}" onclick="toggleTagChoice(this, '${t}')">${t}</div>`).join('');
    }

    function toggleTagChoice(el, tag) {
        if(selectedTags.includes(tag)) selectedTags = selectedTags.filter(t => t !== tag);
        else selectedTags.push(tag);
        el.classList.toggle('selected');
    }

    function closeModal() { document.getElementById('animeModal').style.display = 'none'; }
    renderContent();
</script>
</body>
</html>

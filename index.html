<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ANIWORLD | ULTIMATE ELITE V19</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;900&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           1. 全域變數與主題定義
           ========================================= */
        :root {
            /* 顏色系統 */
            --accent: #00f2ff;
            --accent-pink: #ff00c1;
            --accent-glow: rgba(0, 242, 255, 0.4);
            --bg-dark: #05060f;
            --bg-canvas: #0a0b18;
            --panel-bg: rgba(15, 16, 32, 0.98);
            --text-main: #ffffff;
            --text-sub: #a0aec0;
            --border-color: rgba(255, 255, 255, 0.12);
            --card-surface: rgba(255, 255, 255, 0.06);
            
            /* 圓角定義 */
            --radius-ui: 24px;      /* 常規 UI 圓角 */
            --radius-btn: 50px;     /* 按鈕圓角 */
            --radius-poster: 0px;   /* 封面直角 (巴哈式強制直角) */
            
            /* 動畫緩動 */
            --e-out: cubic-bezier(0.22, 1, 0.36, 1);
            --e-inout: cubic-bezier(0.76, 0, 0.24, 1);
        }

        body.light-mode {
            --bg-dark: #f0f2f5;
            --bg-canvas: #ffffff;
            --panel-bg: rgba(255, 255, 255, 0.98);
            --text-main: #1a1b26;
            --text-sub: #4a5568;
            --border-color: rgba(0, 0, 0, 0.1);
            --card-surface: #ffffff;
            --accent-glow: rgba(0, 242, 255, 0.2);
        }

        /* =========================================
           2. 核心佈局與捲軸優化
           ========================================= */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            background: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Outfit', 'Noto Sans TC', sans-serif;
            overflow-x: hidden;
            line-height: 1.6;
            font-size: 18px;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        /* =========================================
           3. 導航欄設計 (Header)
           ========================================= */
        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 95px;
            background: var(--panel-bg);
            backdrop-filter: blur(25px) saturate(180%);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 4%;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.4s var(--e-out);
        }

        .logo-group {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo-text {
            font-size: 2.5rem;
            font-weight: 900;
            letter-spacing: -3px;
            background: linear-gradient(135deg, var(--accent), var(--accent-pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            cursor: pointer;
            user-select: none;
        }

        .room-badge {
            background: rgba(0, 242, 255, 0.08);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 6px 16px;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 800;
            letter-spacing: 1px;
        }

        .nav-menu {
            display: flex;
            background: rgba(0, 0, 0, 0.15);
            padding: 6px;
            border-radius: 50px;
            border: 1px solid var(--border-color);
            gap: 5px;
        }

        .nav-link {
            padding: 10px 24px;
            border-radius: 40px;
            color: var(--text-sub);
            font-weight: 800;
            font-size: 0.9rem;
            cursor: pointer;
            transition: 0.3s var(--e-out);
            border: 1px solid transparent;
        }

        .nav-link:hover {
            color: var(--text-main);
        }

        .nav-link.active {
            background: var(--accent);
            color: #000;
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 25px;
            font-size: 1.3rem;
        }

        .action-icon {
            cursor: pointer;
            transition: 0.2s;
            color: var(--text-sub);
        }

        .action-icon:hover {
            color: var(--accent);
            transform: scale(1.1);
        }

        /* =========================================
           4. 英雄區塊 (Hero / Banner)
           ========================================= */
        .hero-viewport {
            position: relative;
            width: 100%;
            height: 580px;
            overflow: hidden;
            background: #000;
            margin-top: 0;
        }

        #hero-media {
            width: 100%;
            height: auto;
            min-height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            will-change: transform;
            pointer-events: none;
        }

        .hero-mask {
            position: absolute;
            inset: 0;
            background: linear-gradient(0deg, var(--bg-dark) 5%, rgba(5, 6, 15, 0.2) 50%, transparent 100%);
            z-index: 5;
            pointer-events: none;
        }

        .hero-content {
            position: absolute;
            bottom: 80px;
            left: 6%;
            z-index: 10;
            pointer-events: none;
        }

        .hero-title {
            font-size: 5.5rem;
            font-weight: 900;
            line-height: 0.85;
            margin: 0;
            letter-spacing: -5px;
            text-transform: uppercase;
        }

        .hero-subtitle {
            font-size: 2.2rem;
            font-weight: 400;
            opacity: 0.7;
            letter-spacing: 6px;
            display: block;
            margin-top: 10px;
        }

        /* 按鈕移至右側且縮小 */
        .hero-controls {
            position: absolute;
            bottom: 85px;
            right: 5%;
            display: flex;
            gap: 12px;
            z-index: 20;
        }

        .btn-mini {
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 800;
            cursor: pointer;
            border: 1px solid var(--border-color);
            background: rgba(0, 0, 0, 0.4);
            color: #fff;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.3s var(--e-out);
        }

        .btn-mini:hover {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
            transform: translateY(-3px);
        }

        .hero-viewport.dragging {
            cursor: ns-resize;
        }

        /* =========================================
           5. 動畫網格系統 (Grid & Rectangular Cards)
           ========================================= */
        main {
            padding: 60px 5%;
            background: var(--bg-canvas);
        }

        .filter-container {
            margin-bottom: 50px;
        }

        .tag-wrap {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .tag-pill {
            padding: 10px 24px;
            border-radius: 50px;
            background: var(--card-surface);
            border: 1px solid var(--border-color);
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text-sub);
            cursor: pointer;
            transition: 0.3s var(--e-out);
        }

        .tag-pill:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .tag-pill.active {
            background: var(--accent-pink);
            color: #fff;
            border-color: var(--accent-pink);
            box-shadow: 0 8px 20px rgba(255, 0, 193, 0.3);
        }

        .ani-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 40px;
        }

        .ani-node {
            background: var(--card-surface);
            border-radius: 18px; /* 卡片容器圓潤 */
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: 0.4s var(--e-out);
            position: relative;
            cursor: pointer;
        }

        .ani-node:hover {
            transform: translateY(-12px);
            border-color: var(--accent);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }

        /* 關鍵：直角封面 */
        .ani-poster {
            width: 100%;
            aspect-ratio: 3 / 4.2;
            object-fit: cover;
            border-radius: 0 !important; /* 強制直角 */
            transition: 0.5s var(--e-out);
        }

        .ani-node:hover .ani-poster {
            transform: scale(1.05);
        }

        .ani-meta {
            padding: 22px;
        }

        .ani-label {
            color: var(--accent);
            font-weight: 900;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .ani-name {
            font-size: 1.25rem;
            font-weight: 800;
            margin-top: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-main);
        }

        .fav-hit {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 42px;
            height: 42px;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            opacity: 0;
            transform: scale(0.8);
            transition: 0.3s var(--e-out);
        }

        .ani-node:hover .fav-hit {
            opacity: 1;
            transform: scale(1);
        }

        .fav-hit.active {
            opacity: 1;
            transform: scale(1);
            color: var(--accent-pink);
        }

        /* =========================================
           6. 聊天室與通知組件 (Widgets)
           ========================================= */
        .side-panel {
            position: fixed;
            width: 400px;
            height: 550px;
            background: var(--panel-bg);
            border-radius: 35px;
            border: 1px solid var(--border-color);
            box-shadow: 0 30px 60px rgba(0,0,0,0.6);
            z-index: 3000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: 0.5s var(--e-out);
        }

        #notice-hub { top: 110px; right: 30px; transform: translateX(500px); }
        #chat-hub { bottom: 30px; right: 30px; transform: translateY(700px); }

        .side-panel.open {
            transform: translate(0, 0) !important;
        }

        .panel-head {
            padding: 25px 30px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-head h3 { margin: 0; font-weight: 900; letter-spacing: 1px; }

        .chat-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .msg-bubble {
            padding: 14px 20px;
            border-radius: 22px;
            font-size: 0.95rem;
            max-width: 85%;
            word-break: break-all;
            line-height: 1.5;
            position: relative;
        }

        .msg-bubble.self {
            background: var(--accent);
            color: #000;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
            font-weight: 600;
        }

        .msg-bubble.peer {
            background: var(--card-surface);
            color: var(--text-main);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .chat-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
        }

        .input-dark {
            flex: 1;
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
            padding: 12px 20px;
            border-radius: 15px;
            color: #fff;
            outline: none;
        }

        /* =========================================
           7. 模態視窗與編輯介面 (Modals)
           ========================================= */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.92);
            z-index: 5000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(20px);
            padding: 20px;
        }

        .modal-card {
            width: 100%;
            max-width: 1300px;
            height: 88vh;
            background: var(--bg-dark);
            border-radius: 40px;
            border: 1px solid var(--border-color);
            display: flex;
            overflow: hidden;
            animation: modalPop 0.5s var(--e-out);
        }

        @keyframes modalPop {
            from { transform: scale(0.9) translateY(30px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }

        .modal-visual {
            flex: 1.3;
            background: #000;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-poster {
            max-width: 85%;
            max-height: 85%;
            object-fit: contain;
            z-index: 5;
            border-radius: 0 !important; /* 強制直角封面 */
            box-shadow: 0 30px 60px rgba(0,0,0,0.8);
        }

        .modal-bg-blur {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.3;
            filter: blur(40px);
        }

        .modal-content {
            flex: 1;
            padding: 60px;
            overflow-y: auto;
            background: var(--bg-dark);
        }

        .ep-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(75px, 1fr));
            gap: 30px;
            margin-top: 12px;
        }

        .ep-btn {
            background: var(--card-surface);
            border: 1px solid var(--border-color);
            padding: 12px;
            text-align: center;
            border-radius: 14px;
            cursor: pointer;
            font-weight: 800;
            transition: 0.2s;
        }

        .ep-btn:hover, .ep-btn.active {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
        }

        /* =========================================
           8. 懸浮按鈕 (FAB)
           ========================================= */
        .fab-trigger {
            position: fixed;
            bottom: 40px;
            right: 130px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--accent), var(--accent-pink));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: #fff;
            cursor: pointer;
            z-index: 2500;
            box-shadow: 0 10px 30px rgba(0, 242, 255, 0.4);
            transition: 0.4s var(--e-out);
        }

        .fab-trigger:hover {
            transform: rotate(90deg) scale(1.1);
        }

        .chat-fab {
            position: fixed;
            bottom: 40px;
            right: 40px;
            width: 60px;
            height: 60px;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: #000;
            cursor: pointer;
            z-index: 2500;
            box-shadow: 0 10px 30px var(--accent-glow);
        }

        /* =========================================
           9. 響應式調整
           ========================================= */
        .modal-card {
    max-width: 750px !important;  /* 縮小寬度，不讓它橫向太寬 */
    width: 75%;
    height: 75vh !important;     /* 縱向拉長，佔據更多垂直空間 */
    display: flex;
    flex-direction: column;
}

/* 2. 內容區域：縮小文字，增加行間距 */
.modal-content, .ed-body {
    padding: 40px 60px !important;
}

/* 針對輸入框與文字的精細調整 */
.input-dark, .ed-textarea-v19, select.input-dark {
    font-size: 0.9rem !important;    /* 文字縮小一點 */
    padding: 12px 15px !important;   /* 縮減內距，讓控制項看起來更精緻 */
    line-height: 1.5 !important;     /* 增加行高 */
    letter-spacing: 0.5px;           /* 增加字距，減少擠壓感 */
}

/* 標題文字縮小並變淡，減少視覺重量 */
.input-wrap label, .ed-field label {
    font-size: 0.85rem !important;
    font-weight: 600;
    opacity: 0.7;                   /* 降低亮度，讓視覺焦點在輸入內容上 */
    margin-bottom: 10px;
}

/* 3. 你要求的 1024px 以下覆蓋代碼 */
@media (max-width: 1024px) {
    .modal-card { 
        flex-direction: column; 
        height: 95vh;               /* 手機端保持高度 */
        width: 96%;                 
        max-width: 600px;           /* 限制手機端最大寬度，強制縱向感 */
    }

    .modal-visual { 
        height: 250px;              /* 縮短圖片區，讓文字區變長 */
    }

    .modal-content {
        padding: 25px 20px;         /* 稍微收緊，讓內容垂直延伸 */
    }

    .hero-title { 
        font-size: 1.8rem;          /* 標題縮小，不要佔滿螢幕 */
    }

    /* 讓編輯器內的欄位強制單欄排列，並拉開垂直距離 */
    .ed-row, .modal-editor-content, .ed-body {
        display: flex !important;
        flex-direction: column !important;
        gap: 25px !important;       /* 增加每個欄位之間的垂直間距 */
    }

    .side-panel { 
        width: 92%; 
        right: 4%; 
    }
}
/* =========================================
   針對分類標籤與集數連結的專門覆蓋
   ========================================= */

/* 1. 分類標籤區：讓方格變大、不擁擠 */
#ed-tag-opts {
    display: flex !important;
    flex-wrap: wrap !important;     /* 自動換行 */
    gap: 10px !important;           /* 方格間距拉開 */
    padding: 15px !important;
    background: rgba(255, 255, 255, 0.05) !important; /* 淡淡的底色區分感 */
    border-radius: 12px !important;
    max-height: 320px !important;   /* 給標籤區更多縱向伸展空間 */
    overflow-y: auto !important;
}

/* 讓裡面的標籤按鈕（方格）變大一點 */
#ed-tag-opts div, .tag-chip {
    padding: 10px 15px !important;  /* 增加內距，方格就變大了 */
    background: rgba(0, 0, 0, 0.3) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: 8px !important;
    font-size: 1.0rem !important;   /* 標籤文字稍微大一點點，方便點擊 */
    cursor: pointer;
    transition: 0.2s;
}

/* 2. 集數連結區：縮小方格高度，使其不顯得突兀 */
#ed-links {
    height: 180px !important;       /* 鎖定高度，不讓它佔滿畫面 */
    min-height: 150px !important;
    max-height: 250px !important;
    padding: 15px !important;
    font-family: 'Consolas', 'Monaco', monospace !important; /* 代碼感字體 */
    font-size: 0.85rem !important;  /* 內部文字縮小，對應你的需求 */
    background: rgba(0, 0, 0, 0.2) !important;
    border: 1px solid var(--border-color) !important;
    line-height: 1.6 !important;
    resize: none !important;        /* 關閉手動縮放，保持介面整潔 */
}

/* 3. 在手機端 (1024px以下) 稍微微調標籤區，避免太擠 */
@media (max-width: 1024px) {
    #ed-tag-opts {
        padding: 15px !important;
        gap: 8px !important;
        max-height: 220px !important; /* 手機端高度稍微收斂 */
    }
    
    #ed-tag-opts div, .tag-chip {
        padding: 8px 14px !important;
        font-size: 0.8rem !important;
    }
}
        }
    </style>
</head>
<body onmouseup="Banner.endDrag()" onmouseleave="Banner.endDrag()">

<header id="main-header">
    <div class="logo-group">
        <div class="logo-text" onclick="location.reload()">ANIWORLD</div>
        <div id="room-display" class="room-badge">CONNECTING...</div>
    </div>
    
    <nav class="nav-menu">
        <div class="nav-link active" id="nav-home" onclick="App.setTab('home')">首頁</div>
        <div class="nav-link" id="nav-all" onclick="App.setTab('all')">動畫庫</div>
        <div class="nav-link" id="nav-fav" onclick="App.setTab('fav')">我的收藏</div>
        <div class="nav-link" id="nav-hist" onclick="App.setTab('hist')">觀看紀錄</div>
    </nav>

    <div class="header-actions">
        <i class="fa-solid fa-moon action-icon" onclick="UI.toggleTheme()"></i>
        <i class="fa-solid fa-bell action-icon" onclick="UI.togglePanel('notice-hub')"></i>
        <i class="fa-solid fa-right-from-bracket action-icon" style="color:#ff4444;" onclick="App.logout()"></i>
    </div>
</header>

<section class="hero-viewport" id="hero-area" onmousedown="Banner.startDrag(event)" onmousemove="Banner.doDrag(event)">
    <img id="hero-media" src="https://images.alphacoders.com/133/1339031.png">
    <div class="hero-mask"></div>
    <div class="hero-content">
        <h1 class="hero-title">ANIWORLD<br><span class="hero-subtitle">V19 SUPREME</span></h1>
    </div>
    <div class="hero-controls">
        <button class="btn-mini" onclick="UI.triggerUpload()"><i class="fa-solid fa-camera"></i> 封面更換</button>
        <button class="btn-mini" id="drag-btn" onclick="Banner.toggleDrag()"><i class="fa-solid fa-arrows-up-down"></i> 位置調整</button>
        <input type="file" id="banner-upload" hidden accept="image/*" onchange="Banner.handleFile(this)">
    </div>
</section>

<main>
    <div class="filter-container">
        <div class="tag-wrap" id="tag-cloud">
            </div>
    </div>

    <div class="ani-grid" id="main-grid">
        </div>
</main>

<div id="notice-hub" class="side-panel">
    <div class="panel-head"><h3>系統公告</h3><i class="fa-solid fa-xmark action-icon" onclick="UI.togglePanel('notice-hub')"></i></div>
    <div style="flex:1; display:flex; align-items:center; justify-content:center; opacity:0.3;">
        <p>目前沒有新的通訊紀錄</p>
    </div>
</div>

<div id="chat-hub" class="side-panel">
    <div class="panel-head"><h3>聖域頻道</h3><i class="fa-solid fa-xmark action-icon" onclick="UI.togglePanel('chat-hub')"></i></div>
    <div id="chat-messages" class="chat-body"></div>
    <div class="chat-footer">
        <input type="text" id="chat-input" class="input-dark" placeholder="輸入訊息..." onkeypress="if(event.key==='Enter') Chat.send()">
        <button class="btn-mini" style="background:var(--accent); color:#000;" onclick="Chat.send()"><i class="fa-solid fa-paper-plane"></i></button>
    </div>
</div>

<div class="fab-trigger" onclick="UI.openEdit(null)"><i class="fa-solid fa-plus"></i></div>
<div class="chat-fab" onclick="UI.togglePanel('chat-hub')"><i class="fa-solid fa-comment-dots"></i></div>

<div id="modal-view" class="modal-overlay" onclick="if(event.target==this) UI.closeModals()">
    <div class="modal-card">
        <div class="modal-visual">
            <img id="mv-blur" class="modal-bg-blur">
            <img id="mv-poster" class="modal-poster">
        </div>
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <div>
                    <h2 id="mv-title" style="font-size:3.5rem; margin:0; font-weight:900; line-height:1;">標題載入中</h2>
                    <div id="mv-tags" style="display:flex; gap:10px; margin-top:25px;"></div>
                </div>
                <i id="mv-fav-icon" class="fa-solid fa-heart" style="font-size:2.5rem; cursor:pointer;" onclick="App.toggleFav()"></i>
            </div>
            <div style="margin-top:50px;">
                <h3 style="color:var(--accent); font-size:1.5rem; border-left:4px solid var(--accent); padding-left:15px;">選集播放</h3>
                <div id="mv-eps" class="ep-grid"></div>
            </div>
            <div style="margin-top:60px; padding-top:40px; border-top:1px solid var(--border-color); display:flex; gap:20px;">
                <button id="mv-play-btn" class="btn-mini" style="flex:1; padding:20px; font-size:1.2rem; background:var(--accent); color:#000; border:none;"><i class="fa-solid fa-play"></i> 立即觀看</button>
                <button class="btn-mini" style="padding:20px 30px;" onclick="UI.switchToEdit()"><i class="fa-solid fa-gear"></i></button>
            </div>
        </div>
    </div>
</div>

<div id="modal-editor" class="modal-overlay" onclick="if(event.target==this) UI.closeModals()">
    <div class="modal-card" style="max-width:900px; height:auto; flex-direction:column; padding:50px;">
        <h2 id="ed-header" style="margin:0 0 35px 0; font-size:2.2rem; font-weight:900;">數據維護中心</h2>
        <input type="hidden" id="ed-id">
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
            <div class="input-group">
                <label style="display:block; margin-bottom:8px; font-weight:800; opacity:0.7;">作品名稱</label>
                <input type="text" id="ed-title" class="input-dark" style="width:100%;">
            </div>
            <div class="input-group">
                <label style="display:block; margin-bottom:8px; font-weight:800; opacity:0.7;">封面連結 (URL)</label>
                <input type="text" id="ed-img" class="input-dark" style="width:100%;">
            </div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
            <select id="ed-year" class="input-dark"></select>
            <select id="ed-month" class="input-dark"></select>
        </div>

        <label style="display:block; margin-bottom:12px; font-weight:800; opacity:0.7;">更新週期</label>
        <div id="ed-day-opts" style="display:grid; grid-template-columns:repeat(4, 1fr); gap:10px; margin-bottom:25px;"></div>

        <label style="display:block; margin-bottom:12px; font-weight:800; opacity:0.7;">分類標籤</label>
        <div id="ed-tag-opts" style="display:grid; grid-template-columns:repeat(4, 1fr); gap:10px; margin-bottom:25px; max-height:160px; overflow-y:auto; border:1px solid var(--border-color); padding:15px; border-radius:15px;"></div>

        <label style="display:block; margin-bottom:12px; font-weight:800; opacity:0.7;">集數數據 (格式：第01集|URL)</label>
        <textarea id="ed-links" rows="5" class="input-dark" style="width:100%; margin-bottom:40px; resize:none;"></textarea>

        <div style="display:flex; gap:20px;">
            <button class="btn-mini" style="flex:2; background:var(--accent); color:#000; border:none; padding:18px; font-size:1.1rem;" onclick="App.saveData()">確認儲存</button>
            <button id="ed-del-btn" class="btn-mini" style="flex:1; background:#ff4444; border:none; padding:18px;" onclick="App.deleteData()">移除作品</button>
        </div>
    </div>
</div>

<script>
/**
 * =========================================
 * ANIWORLD ELITE V19 - Core Logic
 * =========================================
 */

// 1. 初始化 Firebase
const firebaseConfig = {
    apiKey: "AIzaSyB_LCa3ZOmcALbxw5SFjx78DzDD3mopXV4",
    databaseURL: "https://aniworld-e53fb-default-rtdb.asia-southeast1.firebasedatabase.app/"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// 2. 全域常量
const CONSTANTS = {
    WEEK_DAYS: ["週一", "週二", "週三", "週四", "週五", "週六", "週日", "完結"],
    TAG_POOL: ["熱血", "冒險", "校園", "戀愛", "異世界", "奇幻", "日常", "懸疑", "百合", "耽美", "戰鬥", "美食", "機甲", "治癒", "致鬱", "後宮", "逆後宮", "肉番", "泡麵番", "劇場版", "運動", "智鬥", "勵志", "科幻", "推理", "特攝", "搞笑", "溫馨", "暗黑", "魔法", "偶像", "音樂", "歷史", "吸血鬼", "獸人", "卡牌", "驚悚", "恐怖"].sort(),
    STORAGE_KEYS: {
        ROOM: 'ani_v19_room',
        USER: 'ani_v19_user',
        BANNER_POS: 'ani_v19_pos_',
        BANNER_IMG: 'ani_v19_img_'
    }
};

// 3. 應用狀態與核心控制器
const App = {
    room: '',
    user: '',
    dataList: [],
    currentTab: 'home',
    currentFilter: '全部',
    currentID: null,
    selectedDay: '週一',
    selectedTags: [],

    init() {
        this.room = localStorage.getItem(CONSTANTS.STORAGE_KEYS.ROOM);
        this.user = localStorage.getItem(CONSTANTS.STORAGE_KEYS.USER);

        if(!this.room) {
            this.room = prompt("聖域房號 (Room ID)：")?.toUpperCase();
            if(this.room) localStorage.setItem(CONSTANTS.STORAGE_KEYS.ROOM, this.room);
            else return;
        }

        if(!this.user) {
            this.user = prompt("冒險者稱號 (Username)：") || '冒險者';
            localStorage.setItem(CONSTANTS.STORAGE_KEYS.USER, this.user);
        }

        document.getElementById('room-display').innerText = `# ${this.room}`;
        
        UI.setupEditorInputs();
        Banner.loadSaved();
        this.bindEvents();
    },

    bindEvents() {
        // 數據監聽
        database.ref(`rooms/${this.room}/data`).on('value', snap => {
            this.dataList = snap.val() ? Object.values(snap.val()) : [];
            this.render();
            UI.renderTags();
        });

        // 聊天監聽
        database.ref(`rooms/${this.room}/chat`).limitToLast(40).on('value', snap => {
            Chat.render(snap.val());
        });
    },

    setTab(tab) {
        this.currentTab = tab;
        document.querySelectorAll('.nav-link').forEach(el => {
            el.classList.toggle('active', el.id === `nav-${tab}`);
        });
        this.render();
    },

    setFilter(tag) {
        this.currentFilter = tag;
        this.render();
        UI.renderTags();
    },

    render() {
        const grid = document.getElementById('main-grid');
        let filtered = [...this.dataList];

        // 頁籤過濾
        if(this.currentTab === 'home') filtered = filtered.sort((a,b) => b.timestamp - a.timestamp).slice(0, 15);
        if(this.currentTab === 'fav') filtered = filtered.filter(a => a.fav);
        if(this.currentTab === 'hist') filtered = filtered.filter(a => a.lastEp).sort((a,b) => b.timestamp - a.timestamp);

        // 標籤過濾
        if(this.currentFilter !== '全部') {
            filtered = filtered.filter(a => (a.tags || []).includes(this.currentFilter));
        }

        grid.innerHTML = filtered.map(item => UI.createCardHTML(item)).join('');
    },

    saveData() {
        const id = document.getElementById('ed-id').value || Date.now().toString();
        const payload = {
            id,
            title: document.getElementById('ed-title').value,
            img: document.getElementById('ed-img').value,
            year: document.getElementById('ed-year').value,
            month: document.getElementById('ed-month').value,
            day: this.selectedDay,
            tags: this.selectedTags,
            links: document.getElementById('ed-links').value.split('\n').filter(l => l.trim()),
            timestamp: Date.now()
        };

        if(!payload.title) return alert("請輸入標題");
        
        database.ref(`rooms/${this.room}/data/${id}`).update(payload)
            .then(() => UI.closeModals());
    },

    deleteData() {
        if(confirm("確定要將此作品從聖域抹除嗎？")) {
            database.ref(`rooms/${this.room}/data/${this.currentID}`).remove()
                .then(() => UI.closeModals());
        }
    },

    toggleFav() {
        const item = this.dataList.find(i => i.id === this.currentID);
        const newState = !item.fav;
        database.ref(`rooms/${this.room}/data/${this.currentID}`).update({ fav: newState });
        
        // 即時更新 UI 圖示
        const icon = document.getElementById('mv-fav-icon');
        icon.style.color = newState ? 'var(--accent-pink)' : 'var(--text-sub)';
        this.render();
    },

    logout() {
        if(confirm("確定要離開當前聖域？")) {
            localStorage.clear();
            location.reload();
        }
    }
};

// 4. UI 渲染與互動控制器
const UI = {
    renderTags() {
        const container = document.getElementById('tag-cloud');
        const tags = ["全部", ...CONSTANTS.TAG_POOL];
        container.innerHTML = tags.map(t => `
            <div class="tag-pill ${App.currentFilter === t ? 'active' : ''}" onclick="App.setFilter('${t}')">${t}</div>
        `).join('');
    },

    createCardHTML(item) {
        return `
            <div class="ani-node" onclick="UI.openView('${item.id}')">
                <div class="fav-hit ${item.fav ? 'active' : ''}" onclick="event.stopPropagation(); App.currentID='${item.id}'; App.toggleFav();">
                    <i class="fa-solid fa-heart"></i>
                </div>
                <img src="${item.img}" class="ani-poster" onerror="this.src='https://via.placeholder.com/400x550?text=NO+IMAGE'">
                <div class="ani-meta">
                    <div class="ani-label">${item.year} • ${item.day}</div>
                    <div class="ani-name">${item.title}</div>
                </div>
            </div>
        `;
    },

    openView(id) {
        requestAnimationFrame(() => {
            App.currentID = id;
            const item = App.dataList.find(i => i.id === id);
            const modal = document.getElementById('modal-view');
            
            modal.style.display = 'flex';
            document.getElementById('mv-title').innerText = item.title;
            document.getElementById('mv-poster').src = item.img;
            document.getElementById('mv-blur').src = item.img;
            
            const favIcon = document.getElementById('mv-fav-icon');
            favIcon.style.color = item.fav ? 'var(--accent-pink)' : 'var(--text-sub)';

            document.getElementById('mv-tags').innerHTML = (item.tags || []).map(t => `<div class="tag-pill active" style="font-size:0.75rem; padding:6px 15px;">${t}</div>`).join('');
            
            const eps = item.links || [];
            document.getElementById('mv-eps').innerHTML = eps.map((link, idx) => `
                <div class="ep-btn ${item.lastEp == idx+1 ? 'active' : ''}" onclick="UI.watch('${item.id}', '${link}', ${idx+1})">${idx+1}</div>
            `).join('');

            document.getElementById('mv-play-btn').onclick = () => {
                const epIdx = (item.lastEp || 1) - 1;
                UI.watch(item.id, eps[epIdx], item.lastEp || 1);
            };
        });
    },

    watch(id, link, ep) {
        database.ref(`rooms/${App.room}/data/${id}`).update({ lastEp: ep, timestamp: Date.now() });
        const finalUrl = link.includes('|') ? link.split('|')[1] : link;
        window.open(finalUrl, '_blank');
    },

    openEdit(id) {
        const modal = document.getElementById('modal-editor');
        modal.style.display = 'flex';
        
        if(!id) {
            // 新增模式
            document.getElementById('ed-header').innerText = "新增動畫作品";
            document.getElementById('ed-id').value = "";
            document.getElementById('ed-title').value = "";
            document.getElementById('ed-img').value = "";
            document.getElementById('ed-links').value = "";
            document.getElementById('ed-del-btn').style.display = 'none';
            App.selectedTags = [];
            this.setEditDay("週一");
        } else {
            // 編輯模式
            const item = App.dataList.find(i => i.id === id);
            document.getElementById('ed-header').innerText = "編輯作品數據";
            document.getElementById('ed-id').value = item.id;
            document.getElementById('ed-title').value = item.title;
            document.getElementById('ed-img').value = item.img;
            document.getElementById('ed-year').value = item.year;
            document.getElementById('ed-month').value = item.month;
            document.getElementById('ed-links').value = (item.links || []).join('\n');
            document.getElementById('ed-del-btn').style.display = 'block';
            App.selectedTags = item.tags || [];
            this.setEditDay(item.day || "週一");
        }
        this.refreshTagOpts();
    },

    switchToEdit() {
        const id = App.currentID;
        this.closeModals();
        setTimeout(() => this.openEdit(id), 100);
    },

    setupEditorInputs() {
        const yearSel = document.getElementById('ed-year');
        const monthSel = document.getElementById('ed-month');
        const dayBox = document.getElementById('ed-day-opts');
        const tagBox = document.getElementById('ed-tag-opts');

        for(let y=2026; y>=2000; y--) yearSel.innerHTML += `<option value="${y}">${y} 年</option>`;
        for(let m=1; m<=12; m++) monthSel.innerHTML += `<option value="${m}月">${m} 月番</option>`;

        CONSTANTS.WEEK_DAYS.forEach(d => {
            dayBox.innerHTML += `<div class="ep-btn" id="eday-${d}" onclick="UI.setEditDay('${d}')">${d}</div>`;
        });

        CONSTANTS.TAG_POOL.forEach(t => {
            tagBox.innerHTML += `<div class="ep-btn" id="etag-${t}" onclick="UI.toggleEditTag('${t}')" style="font-size:0.8rem;">${t}</div>`;
        });
    },

    setEditDay(d) {
        App.selectedDay = d;
        document.querySelectorAll('#ed-day-opts .ep-btn').forEach(b => {
            b.classList.toggle('active', b.innerText === d);
        });
    },

    toggleEditTag(t) {
        if(App.selectedTags.includes(t)) App.selectedTags = App.selectedTags.filter(i => i !== t);
        else App.selectedTags.push(t);
        this.refreshTagOpts();
    },

    refreshTagOpts() {
        document.querySelectorAll('#ed-tag-opts .ep-btn').forEach(b => {
            b.classList.toggle('active', App.selectedTags.includes(b.innerText));
        });
    },

    closeModals() {
        document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
    },

    togglePanel(id) {
        const el = document.getElementById(id);
        const isOpen = el.classList.contains('open');
        document.querySelectorAll('.side-panel').forEach(p => p.classList.remove('open'));
        if(!isOpen) el.classList.add('open');
    },

    toggleTheme() {
        document.body.classList.toggle('light-mode');
    },

    triggerUpload() {
        document.getElementById('banner-upload').click();
    }
};

// 5. Banner GPU 性能控制器
const Banner = {
    isDragging: false,
    startY: 0,
    currentY: 0,
    isEnabled: false,

    loadSaved() {
        const savedPos = localStorage.getItem(CONSTANTS.STORAGE_KEYS.BANNER_POS + App.room);
        const savedImg = localStorage.getItem(CONSTANTS.STORAGE_KEYS.BANNER_IMG + App.room);
        
        if(savedPos) {
            this.currentY = parseFloat(savedPos);
            this.updateTransform();
        }
        if(savedImg) {
            document.getElementById('hero-media').src = savedImg;
        }
    },

    toggleDrag() {
        this.isEnabled = !this.isEnabled;
        const btn = document.getElementById('drag-btn');
        const area = document.getElementById('hero-area');
        
        if(this.isEnabled) {
            btn.style.background = 'var(--accent)';
            btn.style.color = '#000';
            area.classList.add('dragging');
        } else {
            btn.style.background = '';
            btn.style.color = '';
            area.classList.remove('dragging');
        }
    },

    startDrag(e) {
        if(!this.isEnabled) return;
        this.isDragging = true;
        this.startY = e.clientY;
        document.getElementById('hero-media').style.transition = 'none';
    },

    doDrag(e) {
        if(!this.isDragging) return;
        const delta = e.clientY - this.startY;
        this.currentY += delta;
        this.updateTransform();
        this.startY = e.clientY;
    },

    endDrag() {
        if(!this.isDragging) return;
        this.isDragging = false;
        localStorage.setItem(CONSTANTS.STORAGE_KEYS.BANNER_POS + App.room, this.currentY);
        document.getElementById('hero-media').style.transition = '';
    },

    updateTransform() {
        // 使用 GPU 加速的 transform 屬性
        document.getElementById('hero-media').style.transform = `translateY(${this.currentY}px) translateZ(0)`;
    },

    handleFile(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = e.target.result;
                document.getElementById('hero-media').src = data;
                localStorage.setItem(CONSTANTS.STORAGE_KEYS.BANNER_IMG + App.room, data);
            };
            reader.readAsDataURL(input.files[0]);
        }
    }
};

// 6. 聊天室控制器
const Chat = {
    send() {
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        if(!text) return;

        database.ref(`rooms/${App.room}/chat`).push({
            u: App.user,
            t: text,
            ts: Date.now()
        });
        input.value = "";
    },

    render(data) {
        const box = document.getElementById('chat-messages');
        if(!data) return;
        
        box.innerHTML = Object.entries(data).map(([id, msg]) => `
            <div class="msg-bubble ${msg.u === App.user ? 'self' : 'peer'}">
                <div style="font-size:0.7rem; opacity:0.6; margin-bottom:4px; font-weight:900;">${msg.u}</div>
                ${msg.t}
            </div>
        `).join('');
        box.scrollTop = box.scrollHeight;
    }
};

// 啟動聖域
App.init();

</script>
</body>
</html>
